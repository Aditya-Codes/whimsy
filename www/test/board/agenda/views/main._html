#!/usr/bin/ruby

#
# Main "layout" for the application, houses a single view
#

_html ng_app: 'AsfBoardAgenda' do
  _script src: 'js/app.js'
  _script src: 'js/services.js'
  _script src: 'js/filters.js'

  _link rel: 'stylesheet', href: 'stylesheets/app.css'

  _body ng_controller: 'Layout' do
    # sibling navigation links and banner
    _header.navbar.navbar_fixed_top class: '{{ item | color }}' do
      _div.navbar_brand '{{ title }}'
      _ul.nav.nav_pills.navbar_right do
        _li.dropdown ng_show: 'item.title' do
          _a.info!.dropdown_toggle data_toggle: "dropdown" do
            _ 'info'
            _b.caret
          end
          _dl.dropdown_menu.dl_horizontal do
            _dt 'Attach'
            _dd '{{ item.attach }}'
            _dt 'Author'
            _dd '{{ item.owner }}'
            _dt 'Shepherd'
            _dd '{{ item.shepherd }}'
            _dt 'Approved', ng_show: 'item.approved'
            _dd '{{ item.approved && item.approved.join(", ") }}', 
              ng_show: 'item.approved'
            _dt 'Links', ng_show: 'item.roster || item.prior_reports'
            _dd ng_show: 'item.roster' do
              _a 'Roster', ng_href: '{{ item.roster }}'
            end
            _dd ng_show: 'item.prior_reports' do
              _a 'Prior Reports', ng_href: '{{ item.prior_reports }}'
            end
          end
        end

        _li_.dropdown do
          _a.nav!.dropdown_toggle data_toggle: "dropdown" do
            _ 'navigation'
            _b.caret
          end
          _ul.dropdown_menu do
            _li! {_a.agenda! 'Agenda', href: '#'}
            _li! ng_repeat: 'item in toc' do
              _a '{{ item.index }}', ng_href: '{{ "#" + item.title }}'
            end
          end
        end
      end
    end

    userid = ENV['REMOTE_USER']
    userid = userid.dup.untaint if userid =~ /\A[-\w]+\Z/
    _main :ng_view, data_agenda: @agenda, 
      data_availid: userid, data_initials: ASF::Auth::DIRECTORS[userid],
      data_firstname: Etc.getpwnam(userid)[4].split(',').first.split(' ').first

    _aside.agendas! ng_show: 'false' do
      _h2 'Other Board Meeting Agendas'
      _ul do
        @agendas.each do |agenda|
          _li! { _a agenda, href: agenda }
        end
      end
    end

    _footer_.navbar.navbar_fixed_bottom class: '{{ item | color }}' do
      _a.backlink.navbar_brand '{{ prev && prev.title }}', rel: 'prev',
        ng_href: '{{ prev && prev.href }}', ng_show: 'prev'
      
      _span ng_repeat: 'button in buttons' do
        _ng_include src: 'button'
      end

      _a.nextlink.navbar_brand '{{ next && next.title }}', rel: 'next',
        ng_href: '{{ next && next.href }}', ng_show: 'next'
    end
  end
end
